<!--/////////////////////////////////////////////////-->
<!--///// BitSatCredit Admin Dashboard //////////////-->
<!--/////////////////////////////////////////////////-->

{% extends "base.html" %}

{% from "macros.jinja" import window_vars with context %}
{% block scripts %}
{{ window_vars(user) }}

<script src="{{ static_url_for('bitsatcredit/static', path='js/index.js') }}"></script>

{% endblock %}

{% block page %}
<div class="row q-col-gutter-md">
  <div class="col-12 col-md-8 col-lg-7 q-gutter-y-md">

    <!-- Statistics Cards -->
    <div class="row q-col-gutter-sm">
      <div class="col-6 col-md-3">
        <q-card>
          <q-card-section class="text-center">
            <div class="text-h6">${ stats.total_users }</div>
            <div class="text-caption">Total Users</div>
          </q-card-section>
        </q-card>
      </div>
      <div class="col-6 col-md-3">
        <q-card>
          <q-card-section class="text-center">
            <div class="text-h6">${ stats.total_balance }</div>
            <div class="text-caption">Total Balance (sats)</div>
          </q-card-section>
        </q-card>
      </div>
      <div class="col-6 col-md-3">
        <q-card>
          <q-card-section class="text-center">
            <div class="text-h6">${ stats.total_spent }</div>
            <div class="text-caption">Total Spent</div>
          </q-card-section>
        </q-card>
      </div>
      <div class="col-6 col-md-3">
        <q-card>
          <q-card-section class="text-center">
            <div class="text-h6">${ stats.total_messages }</div>
            <div class="text-caption">Messages Sent</div>
          </q-card-section>
        </q-card>
      </div>
    </div>

    <!-- User Management Section -->
    <div class="q-mt-lg">
      <span class="text-h5">Users</span>
    </div>
    <q-card id="userCard" class="q-mt-xs">
      <q-card-section>
        <div class="row items-center no-wrap q-mb-md">
          <div class="col">
            <q-input
              :label="$t('search')"
              dense
              class="q-pr-xl"
              v-model="userTable.search"
            >
              <template v-slot:before>
                <q-icon name="search"></q-icon>
              </template>
              <template v-slot:append>
                <q-icon
                  v-if="userTable.search !== ''"
                  name="close"
                  @click="userTable.search = ''"
                  class="cursor-pointer"
                ></q-icon>
              </template>
            </q-input>
          </div>
          <div class="col-auto q-gutter-xs">
            <q-btn
              v-if="selectedUsers.length > 0"
              color="primary"
              icon="add_circle"
              :label="`Bulk Add Credits (${selectedUsers.length})`"
              @click="showBulkAddCreditsDialog"
            ></q-btn>
            <q-btn
              flat
              color="grey"
              icon="file_download"
              @click="exportUsersCSV"
            >CSV</q-btn>
          </div>
        </div>
        <q-table
          dense
          flat
          :rows="filteredUsers"
          row-key="npub"
          :columns="userTable.columns"
          :pagination.sync="userTable.pagination"
          :loading="userTable.loading"
        >
          <template v-slot:header="props">
            <q-tr :props="props">
              <q-th auto-width>
                <q-checkbox
                  v-model="selectAll"
                  @update:model-value="toggleSelectAll"
                  dense
                ></q-checkbox>
              </q-th>
              <q-th auto-width></q-th>
              <q-th v-for="col in props.cols" :key="col.name" :props="props">
                ${ col.label }
              </q-th>
            </q-tr>
          </template>

          <template v-slot:body="props">
            <q-tr :props="props">
              <q-td auto-width>
                <q-checkbox
                  v-model="selectedUsers"
                  :val="props.row.npub"
                  dense
                ></q-checkbox>
              </q-td>
              <q-td auto-width>
                <q-btn
                  flat
                  dense
                  size="xs"
                  icon="visibility"
                  color="primary"
                  @click="showUserDetails(props.row)"
                >
                  <q-tooltip>View Details</q-tooltip>
                </q-btn>
              </q-td>
              <q-td key="npub" :props="props">
                ${ props.row.npub.substring(0, 16) }...
                <q-tooltip>${ props.row.npub }</q-tooltip>
              </q-td>
              <q-td key="balance_sats" :props="props">
                ${ props.row.balance_sats }
              </q-td>
              <q-td key="total_spent" :props="props">
                ${ props.row.total_spent }
              </q-td>
              <q-td key="total_deposited" :props="props">
                ${ props.row.total_deposited }
              </q-td>
              <q-td key="message_count" :props="props">
                ${ props.row.message_count }
              </q-td>
              <q-td key="memo" :props="props">
                <div class="row items-center no-wrap">
                  <span class="text-caption ellipsis" style="max-width: 150px;">
                    ${ props.row.memo || '-' }
                  </span>
                  <q-btn
                    flat
                    dense
                    size="xs"
                    icon="edit"
                    color="grey"
                    @click="showEditMemoDialog(props.row)"
                    class="q-ml-xs"
                  >
                    <q-tooltip>Edit Memo</q-tooltip>
                  </q-btn>
                </div>
              </q-td>
              <q-td key="updated_at" :props="props">
                ${ dateFromNow(props.row.updated_at) }
              </q-td>
            </q-tr>
          </template>
        </q-table>
      </q-card-section>
    </q-card>

    <!-- Recent Transactions Section -->
    <div class="q-mt-lg">
      <span class="text-h5">Recent Transactions</span>
    </div>
    <q-card id="transactionCard" class="q-mt-xs">
      <q-card-section>
        <q-table
          dense
          flat
          :rows="transactionList"
          row-key="id"
          :columns="transactionTable.columns"
          :pagination.sync="transactionTable.pagination"
          :loading="transactionTable.loading"
        >
          <template v-slot:header="props">
            <q-tr :props="props">
              <q-th v-for="col in props.cols" :key="col.name" :props="props">
                ${ col.label }
              </q-th>
            </q-tr>
          </template>

          <template v-slot:body="props">
            <q-tr :props="props">
              <q-td key="created_at" :props="props">
                ${ dateFromNow(props.row.created_at) }
              </q-td>
              <q-td key="npub" :props="props">
                ${ props.row.npub.substring(0, 12) }...
              </q-td>
              <q-td key="type" :props="props">
                <q-badge :color="props.row.type === 'deposit' ? 'positive' : 'negative'">
                  ${ props.row.type }
                </q-badge>
              </q-td>
              <q-td key="amount_sats" :props="props">
                ${ props.row.amount_sats }
              </q-td>
              <q-td key="memo" :props="props">
                ${ props.row.memo || '-' }
              </q-td>
            </q-tr>
          </template>
        </q-table>
      </q-card-section>
    </q-card>

  </div>

  <!-- Right Sidebar -->
  <div class="col-12 col-md-4 col-lg-5 q-gutter-y-md">

    <!-- Settings Card -->
    <q-card>
      <q-card-section>
        <h6 class="q-mb-sm q-mt-none">Settings</h6>
        <div class="q-gutter-sm">
          <q-select
            filled
            dense
            v-model="selectedWallet"
            :options="walletOptions"
            label="Payment Wallet"
            hint="Which wallet receives top-up payments"
            @input="saveWalletSetting"
          >
            <template v-slot:prepend>
              <q-icon name="account_balance_wallet"></q-icon>
            </template>
          </q-select>

          <q-input
            filled
            dense
            v-model="externalUrl"
            label="External URL (optional)"
            hint="For sharing public page externally (e.g., https://your-domain.com)"
            @blur="saveExternalUrl"
          >
            <template v-slot:prepend>
              <q-icon name="public"></q-icon>
            </template>
          </q-input>

          <q-input
            filled
            dense
            v-model.number="pricePerMessage"
            type="number"
            label="Price per Message (sats)"
            hint="Cost for users to send one satellite message"
            @blur="savePriceSetting"
            :rules="[val => val >= 1 || 'Price must be at least 1 sat']"
          >
            <template v-slot:prepend>
              <q-icon name="attach_money"></q-icon>
            </template>
          </q-input>

          <q-separator class="q-my-md"></q-separator>

          <!-- System Status Toggle -->
          <div class="row items-center q-gutter-md">
            <div class="col">
              <div class="text-subtitle2">System Status</div>
              <div class="text-caption text-grey-7">
                Control if relay script can process messages
              </div>
            </div>
            <div>
              <q-badge
                :color="systemStatus === 'online' ? 'positive' : 'negative'"
                :label="systemStatus === 'online' ? 'ONLINE' : 'OFFLINE'"
                class="q-mr-sm"
              ></q-badge>
              <q-toggle
                v-model="systemOnline"
                color="positive"
                @update:model-value="toggleSystemStatus"
                :icon="systemOnline ? 'wifi' : 'wifi_off'"
              ></q-toggle>
            </div>
          </div>

          <q-input
            v-if="systemStatus === 'offline'"
            filled
            dense
            v-model="systemStatusMessage"
            label="Offline Message (optional)"
            hint="Shown to users on public page"
            @blur="saveStatusMessage"
            class="q-mt-sm"
          >
            <template v-slot:prepend>
              <q-icon name="info"></q-icon>
            </template>
          </q-input>
        </div>
      </q-card-section>
    </q-card>

    <!-- Admin Actions Card -->
    <q-card>
      <q-card-section>
        <h6 class="q-mb-sm q-mt-none">Admin Actions</h6>
        <div class="q-gutter-sm">
          <q-btn
            color="primary"
            icon="person_add"
            label="Add User Credits"
            class="full-width"
            @click="showAddCreditsDialog"
          ></q-btn>
          <q-btn
            color="secondary"
            icon="add_circle"
            label="Create User"
            class="full-width"
            @click="showCreateUserDialog"
          ></q-btn>
        </div>
      </q-card-section>
    </q-card>

    <!-- Public Top-Up Page Card -->
    <q-card>
      <q-card-section>
        <h6 class="q-mb-sm q-mt-none">Public Top-Up Page</h6>
        <p class="q-my-none text-caption q-mb-md">
          Share this link with users so they can top up their credits:
        </p>
        <q-input
          readonly
          filled
          dense
          :value="publicPageUrl"
          label="Public URL"
        >
          <template v-slot:append>
            <q-btn
              flat
              dense
              icon="content_copy"
              @click="copyPublicUrl"
            >
              <q-tooltip>Copy Link</q-tooltip>
            </q-btn>
            <q-btn
              flat
              dense
              icon="open_in_new"
              type="a"
              :href="publicPageUrl"
              target="_blank"
            >
              <q-tooltip>Open in New Tab</q-tooltip>
            </q-btn>
          </template>
        </q-input>
      </q-card-section>
    </q-card>

    <q-card>
      <q-card-section>
        <h6 class="q-mb-sm q-mt-none">BitSatCredit</h6>
        <p class="q-my-none">
          User credit system for BitSatRelay satellite messaging.
          Users top up credits via Lightning payments, then spend credits to send satellite messages.
        </p>
      </q-card-section>
    </q-card>

    {% include "bitsatcredit/_api_docs.html" %}
  </div>
</div>

<!-- User Details Dialog -->
<q-dialog v-model="userDetailsDialog.show">
  <q-card style="min-width: 600px">
    <q-card-section>
      <div class="text-h6">User Details</div>
    </q-card-section>

    <q-card-section v-if="userDetailsDialog.user" class="q-pt-none">
      <div class="row q-col-gutter-sm">
        <div class="col-12">
          <strong>Npub:</strong> ${ userDetailsDialog.user.npub }
        </div>
        <div class="col-6">
          <strong>Balance:</strong> ${ userDetailsDialog.user.balance_sats } sats
        </div>
        <div class="col-6">
          <strong>Messages Sent:</strong> ${ userDetailsDialog.user.message_count }
        </div>
        <div class="col-6">
          <strong>Total Deposited:</strong> ${ userDetailsDialog.user.total_deposited } sats
        </div>
        <div class="col-6">
          <strong>Total Spent:</strong> ${ userDetailsDialog.user.total_spent } sats
        </div>
        <div class="col-12">
          <strong>Created:</strong> ${ new Date(userDetailsDialog.user.created_at * 1000).toLocaleString() }
        </div>
        <div class="col-12">
          <strong>Last Activity:</strong> ${ new Date(userDetailsDialog.user.updated_at * 1000).toLocaleString() }
        </div>
      </div>

      <div class="q-mt-md">
        <div class="text-subtitle1">Transaction History</div>
        <q-list bordered separator>
          <q-item v-for="tx in userDetailsDialog.transactions" :key="tx.id">
            <q-item-section>
              <q-item-label>
                <q-badge :color="tx.type === 'deposit' ? 'positive' : 'negative'">
                  ${ tx.type }
                </q-badge>
                ${ tx.amount_sats } sats
              </q-item-label>
              <q-item-label caption>
                ${ tx.memo || 'No memo' } - ${ dateFromNow(tx.created_at) }
              </q-item-label>
            </q-item-section>
          </q-item>
          <q-item v-if="userDetailsDialog.transactions.length === 0">
            <q-item-section>
              <q-item-label>No transactions yet</q-item-label>
            </q-item-section>
          </q-item>
        </q-list>
      </div>
    </q-card-section>

    <q-card-actions align="right">
      <q-btn
        color="negative"
        icon="delete"
        label="Delete User"
        @click="confirmDeleteUser"
      ></q-btn>
      <q-space></q-space>
      <q-btn
        color="primary"
        icon="edit"
        label="Edit Balance"
        @click="editUserBalance"
      ></q-btn>
      <q-btn flat label="Close" v-close-popup></q-btn>
    </q-card-actions>
  </q-card>
</q-dialog>

<!-- Add Credits Dialog -->
<q-dialog v-model="addCreditsDialog.show">
  <q-card style="min-width: 400px">
    <q-card-section>
      <div class="text-h6">Add Credits to User</div>
    </q-card-section>

    <q-card-section class="q-pt-none">
      <q-input
        filled
        v-model="addCreditsDialog.npub"
        label="User Npub"
        hint="Enter npub1... or search existing user"
        :rules="[val => (val && val.startsWith('npub1') && val.length === 63) || 'Invalid npub']"
      >
        <template v-slot:prepend>
          <q-icon name="person"></q-icon>
        </template>
      </q-input>

      <q-input
        filled
        v-model.number="addCreditsDialog.amount"
        type="number"
        label="Amount (sats)"
        hint="Amount of credits to add (free/manual top-up)"
        class="q-mt-md"
        :rules="[val => val > 0 || 'Amount must be positive']"
      >
        <template v-slot:prepend>
          <q-icon name="add_circle"></q-icon>
        </template>
      </q-input>

      <q-input
        filled
        v-model="addCreditsDialog.memo"
        label="Memo (optional)"
        hint="Reason for credit addition"
        class="q-mt-md"
      >
        <template v-slot:prepend>
          <q-icon name="notes"></q-icon>
        </template>
      </q-input>
    </q-card-section>

    <q-card-actions align="right">
      <q-btn flat label="Cancel" v-close-popup></q-btn>
      <q-btn
        color="primary"
        label="Add Credits"
        @click="addCreditsToUser"
        :disable="!addCreditsDialog.npub || !addCreditsDialog.amount"
      ></q-btn>
    </q-card-actions>
  </q-card>
</q-dialog>

<!-- Create User Dialog -->
<q-dialog v-model="createUserDialog.show">
  <q-card style="min-width: 400px">
    <q-card-section>
      <div class="text-h6">Create New User</div>
    </q-card-section>

    <q-card-section class="q-pt-none">
      <q-input
        filled
        v-model="createUserDialog.npub"
        label="User Npub"
        hint="Enter npub1... (63 characters)"
        :rules="[val => (val && val.startsWith('npub1') && val.length === 63) || 'Invalid npub']"
      >
        <template v-slot:prepend>
          <q-icon name="person"></q-icon>
        </template>
      </q-input>

      <q-input
        filled
        v-model.number="createUserDialog.initialBalance"
        type="number"
        label="Initial Balance (sats)"
        hint="Starting credits (can be 0)"
        class="q-mt-md"
        :rules="[val => val >= 0 || 'Amount must be 0 or positive']"
      >
        <template v-slot:prepend>
          <q-icon name="account_balance"></q-icon>
        </template>
      </q-input>
    </q-card-section>

    <q-card-actions align="right">
      <q-btn flat label="Cancel" v-close-popup></q-btn>
      <q-btn
        color="primary"
        label="Create User"
        @click="createNewUser"
        :disable="!createUserDialog.npub"
      ></q-btn>
    </q-card-actions>
  </q-card>
</q-dialog>

<!-- Edit Balance Dialog -->
<q-dialog v-model="editBalanceDialog.show">
  <q-card style="min-width: 400px">
    <q-card-section>
      <div class="text-h6">Edit User Balance</div>
    </q-card-section>

    <q-card-section class="q-pt-none">
      <div class="q-mb-md text-caption">
        User: ${ editBalanceDialog.npub }
      </div>
      <div class="q-mb-md">
        Current Balance: <strong>${ editBalanceDialog.currentBalance } sats</strong>
      </div>

      <q-input
        filled
        v-model.number="editBalanceDialog.newBalance"
        type="number"
        label="New Balance (sats)"
        hint="Set new balance amount"
        :rules="[val => val >= 0 || 'Balance cannot be negative']"
      >
        <template v-slot:prepend>
          <q-icon name="edit"></q-icon>
        </template>
      </q-input>

      <q-input
        filled
        v-model="editBalanceDialog.memo"
        label="Memo (optional)"
        hint="Reason for balance adjustment"
        class="q-mt-md"
      >
        <template v-slot:prepend>
          <q-icon name="notes"></q-icon>
        </template>
      </q-input>
    </q-card-section>

    <q-card-actions align="right">
      <q-btn flat label="Cancel" v-close-popup></q-btn>
      <q-btn
        color="primary"
        label="Update Balance"
        @click="updateUserBalance"
      ></q-btn>
    </q-card-actions>
  </q-card>
</q-dialog>

<!-- Edit Memo Dialog -->
<q-dialog v-model="editMemoDialog.show">
  <q-card style="min-width: 400px">
    <q-card-section>
      <div class="text-h6">Edit User Memo</div>
    </q-card-section>

    <q-card-section class="q-pt-none">
      <div class="q-mb-md text-caption">
        User: ${ editMemoDialog.npub ? editMemoDialog.npub.substring(0, 16) + '...' : '' }
      </div>

      <q-input
        filled
        v-model="editMemoDialog.memo"
        label="Admin Memo/Note"
        hint="Private note for admin reference (not visible to user)"
        type="textarea"
        rows="3"
      >
        <template v-slot:prepend>
          <q-icon name="notes"></q-icon>
        </template>
      </q-input>
    </q-card-section>

    <q-card-actions align="right">
      <q-btn flat label="Cancel" v-close-popup></q-btn>
      <q-btn
        color="primary"
        label="Save Memo"
        @click="saveUserMemo"
      ></q-btn>
    </q-card-actions>
  </q-card>
</q-dialog>

<!-- Bulk Add Credits Dialog -->
<q-dialog v-model="bulkAddCreditsDialog.show">
  <q-card style="min-width: 400px">
    <q-card-section>
      <div class="text-h6">Bulk Add Credits</div>
    </q-card-section>

    <q-card-section class="q-pt-none">
      <div class="q-mb-md">
        Adding credits to <strong>${ selectedUsers.length }</strong> user(s)
      </div>

      <q-input
        filled
        v-model.number="bulkAddCreditsDialog.amount"
        type="number"
        label="Amount per User (sats)"
        hint="Each selected user will receive this amount"
        :rules="[val => val > 0 || 'Amount must be positive']"
      >
        <template v-slot:prepend>
          <q-icon name="add_circle"></q-icon>
        </template>
      </q-input>

      <q-input
        filled
        v-model="bulkAddCreditsDialog.memo"
        label="Memo (optional)"
        hint="Reason for bulk credit addition"
        class="q-mt-md"
      >
        <template v-slot:prepend>
          <q-icon name="notes"></q-icon>
        </template>
      </q-input>
    </q-card-section>

    <q-card-actions align="right">
      <q-btn flat label="Cancel" v-close-popup></q-btn>
      <q-btn
        color="primary"
        label="Add Credits to All"
        @click="bulkAddCreditsToUsers"
        :disable="!bulkAddCreditsDialog.amount"
      ></q-btn>
    </q-card-actions>
  </q-card>
</q-dialog>

{% endblock %}
