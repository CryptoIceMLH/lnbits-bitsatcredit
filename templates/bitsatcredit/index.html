<!--/////////////////////////////////////////////////-->
<!--///// BitSatCredit Admin Dashboard //////////////-->
<!--/////////////////////////////////////////////////-->

{% extends "base.html" %}

{% from "macros.jinja" import window_vars with context %}
{% block scripts %}
{{ window_vars(user) }}

<script src="{{ static_url_for('bitsatcredit/static', path='js/index.js') }}"></script>

{% endblock %}

{% block page %}
<div class="row q-col-gutter-md">
  <div class="col-12 col-md-8 col-lg-7 q-gutter-y-md">

    <!-- Statistics Cards -->
    <div class="row q-col-gutter-sm">
      <div class="col-6 col-md-3">
        <q-card>
          <q-card-section class="text-center">
            <div class="text-h6">${ stats.total_users }</div>
            <div class="text-caption">Total Users</div>
          </q-card-section>
        </q-card>
      </div>
      <div class="col-6 col-md-3">
        <q-card>
          <q-card-section class="text-center">
            <div class="text-h6">${ stats.total_balance }</div>
            <div class="text-caption">Total Balance (sats)</div>
          </q-card-section>
        </q-card>
      </div>
      <div class="col-6 col-md-3">
        <q-card>
          <q-card-section class="text-center">
            <div class="text-h6">${ stats.total_spent }</div>
            <div class="text-caption">Total Spent</div>
          </q-card-section>
        </q-card>
      </div>
      <div class="col-6 col-md-3">
        <q-card>
          <q-card-section class="text-center">
            <div class="text-h6">${ stats.total_messages }</div>
            <div class="text-caption">Messages Sent</div>
          </q-card-section>
        </q-card>
      </div>
    </div>

    <!-- User Management Section -->
    <div class="q-mt-lg">
      <span class="text-h5">Users</span>
    </div>
    <q-card id="userCard" class="q-mt-xs">
      <q-card-section>
        <div class="row items-center no-wrap q-mb-md">
          <div class="col">
            <q-input
              :label="$t('search')"
              dense
              class="q-pr-xl"
              v-model="userTable.search"
            >
              <template v-slot:before>
                <q-icon name="search"></q-icon>
              </template>
              <template v-slot:append>
                <q-icon
                  v-if="userTable.search !== ''"
                  name="close"
                  @click="userTable.search = ''"
                  class="cursor-pointer"
                ></q-icon>
              </template>
            </q-input>
          </div>
          <div class="col-auto">
            <q-btn
              flat
              color="grey"
              icon="file_download"
              @click="exportUsersCSV"
            >CSV</q-btn>
          </div>
        </div>
        <q-table
          dense
          flat
          :rows="filteredUsers"
          row-key="npub"
          :columns="userTable.columns"
          :pagination.sync="userTable.pagination"
          :loading="userTable.loading"
        >
          <template v-slot:header="props">
            <q-tr :props="props">
              <q-th auto-width></q-th>
              <q-th v-for="col in props.cols" :key="col.name" :props="props">
                ${ col.label }
              </q-th>
            </q-tr>
          </template>

          <template v-slot:body="props">
            <q-tr :props="props">
              <q-td auto-width>
                <q-btn
                  flat
                  dense
                  size="xs"
                  icon="visibility"
                  color="primary"
                  @click="showUserDetails(props.row)"
                >
                  <q-tooltip>View Details</q-tooltip>
                </q-btn>
              </q-td>
              <q-td key="npub" :props="props">
                ${ props.row.npub.substring(0, 16) }...
                <q-tooltip>${ props.row.npub }</q-tooltip>
              </q-td>
              <q-td key="balance_sats" :props="props">
                ${ props.row.balance_sats }
              </q-td>
              <q-td key="total_spent" :props="props">
                ${ props.row.total_spent }
              </q-td>
              <q-td key="total_deposited" :props="props">
                ${ props.row.total_deposited }
              </q-td>
              <q-td key="message_count" :props="props">
                ${ props.row.message_count }
              </q-td>
              <q-td key="updated_at" :props="props">
                ${ dateFromNow(props.row.updated_at) }
              </q-td>
            </q-tr>
          </template>
        </q-table>
      </q-card-section>
    </q-card>

    <!-- Recent Transactions Section -->
    <div class="q-mt-lg">
      <span class="text-h5">Recent Transactions</span>
    </div>
    <q-card id="transactionCard" class="q-mt-xs">
      <q-card-section>
        <q-table
          dense
          flat
          :rows="transactionList"
          row-key="id"
          :columns="transactionTable.columns"
          :pagination.sync="transactionTable.pagination"
          :loading="transactionTable.loading"
        >
          <template v-slot:header="props">
            <q-tr :props="props">
              <q-th v-for="col in props.cols" :key="col.name" :props="props">
                ${ col.label }
              </q-th>
            </q-tr>
          </template>

          <template v-slot:body="props">
            <q-tr :props="props">
              <q-td key="created_at" :props="props">
                ${ dateFromNow(props.row.created_at) }
              </q-td>
              <q-td key="npub" :props="props">
                ${ props.row.npub.substring(0, 12) }...
              </q-td>
              <q-td key="type" :props="props">
                <q-badge :color="props.row.type === 'deposit' ? 'positive' : 'negative'">
                  ${ props.row.type }
                </q-badge>
              </q-td>
              <q-td key="amount_sats" :props="props">
                ${ props.row.amount_sats }
              </q-td>
              <q-td key="memo" :props="props">
                ${ props.row.memo || '-' }
              </q-td>
            </q-tr>
          </template>
        </q-table>
      </q-card-section>
    </q-card>

  </div>

  <!-- Right Sidebar -->
  <div class="col-12 col-md-4 col-lg-5 q-gutter-y-md">
    <q-card>
      <q-card-section>
        <h6 class="q-mb-sm q-mt-none">Public Top-Up Page</h6>
        <p class="q-my-none text-caption q-mb-md">
          Share this link with users so they can top up their credits:
        </p>
        <q-input
          readonly
          filled
          dense
          :value="publicPageUrl"
          label="Public URL"
        >
          <template v-slot:append>
            <q-btn
              flat
              dense
              icon="content_copy"
              @click="copyPublicUrl"
            >
              <q-tooltip>Copy Link</q-tooltip>
            </q-btn>
            <q-btn
              flat
              dense
              icon="open_in_new"
              type="a"
              :href="publicPageUrl"
              target="_blank"
            >
              <q-tooltip>Open in New Tab</q-tooltip>
            </q-btn>
          </template>
        </q-input>
      </q-card-section>
    </q-card>

    <q-card>
      <q-card-section>
        <h6 class="q-mb-sm q-mt-none">BitSatCredit</h6>
        <p class="q-my-none">
          User credit system for BitSatRelay satellite messaging.
          Users top up credits via Lightning payments, then spend credits to send satellite messages.
        </p>
      </q-card-section>
    </q-card>

    {% include "bitsatcredit/_api_docs.html" %}
  </div>
</div>

<!-- User Details Dialog -->
<q-dialog v-model="userDetailsDialog.show">
  <q-card style="min-width: 600px">
    <q-card-section>
      <div class="text-h6">User Details</div>
    </q-card-section>

    <q-card-section v-if="userDetailsDialog.user" class="q-pt-none">
      <div class="row q-col-gutter-sm">
        <div class="col-12">
          <strong>Npub:</strong> ${ userDetailsDialog.user.npub }
        </div>
        <div class="col-6">
          <strong>Balance:</strong> ${ userDetailsDialog.user.balance_sats } sats
        </div>
        <div class="col-6">
          <strong>Messages Sent:</strong> ${ userDetailsDialog.user.message_count }
        </div>
        <div class="col-6">
          <strong>Total Deposited:</strong> ${ userDetailsDialog.user.total_deposited } sats
        </div>
        <div class="col-6">
          <strong>Total Spent:</strong> ${ userDetailsDialog.user.total_spent } sats
        </div>
        <div class="col-12">
          <strong>Created:</strong> ${ new Date(userDetailsDialog.user.created_at).toLocaleString() }
        </div>
        <div class="col-12">
          <strong>Last Activity:</strong> ${ new Date(userDetailsDialog.user.updated_at).toLocaleString() }
        </div>
      </div>

      <div class="q-mt-md">
        <div class="text-subtitle1">Transaction History</div>
        <q-list bordered separator>
          <q-item v-for="tx in userDetailsDialog.transactions" :key="tx.id">
            <q-item-section>
              <q-item-label>
                <q-badge :color="tx.type === 'deposit' ? 'positive' : 'negative'">
                  ${ tx.type }
                </q-badge>
                ${ tx.amount_sats } sats
              </q-item-label>
              <q-item-label caption>
                ${ tx.memo || 'No memo' } - ${ dateFromNow(tx.created_at) }
              </q-item-label>
            </q-item-section>
          </q-item>
          <q-item v-if="userDetailsDialog.transactions.length === 0">
            <q-item-section>
              <q-item-label>No transactions yet</q-item-label>
            </q-item-section>
          </q-item>
        </q-list>
      </div>
    </q-card-section>

    <q-card-actions align="right">
      <q-btn flat label="Close" color="primary" v-close-popup></q-btn>
    </q-card-actions>
  </q-card>
</q-dialog>

{% endblock %}
