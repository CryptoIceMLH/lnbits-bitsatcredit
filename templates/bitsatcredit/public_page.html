<!--/////////////////////////////////////////////////-->
<!--////////////////USER FACING PAGE/////////////////-->
<!--/////////////////////////////////////////////////-->

{% extends "public.html" %} {% block page %}
<div class="row q-col-gutter-md justify-center">
  <div class="col-12 col-sm-6 col-md-5 col-lg-4">
    <q-card v-if="invoicePaid" class="q-pa-lg">
      <q-card-section class="q-pa-none q-mb-md">
        <span class="text-h5">Relay:</span>
        <span v-text="relayId" class="text-h5"></span>
        <q-icon
          name="check"
          transition-show="fade"
          class="text-light-green"
          style="font-size: min(90vw, 40em)"
        ></q-icon>
      </q-card-section>
    </q-card>
    <q-card v-else-if="paymentRequest" class="q-pa-lg">
      <q-card-section class="q-pa-none q-mb-md">
        <span class="text-h5">Relay:</span>
        <span v-text="relayId" class="text-h5"></span>
      </q-card-section>
      <q-card-section class="q-pa-none q-mb-md">
        <lnbits-qrcode
          :href="'lightning:' + paymentRequest"
          :value="'lightning:' + paymentRequest"
        ></lnbits-qrcode>
      </q-card-section>
    </q-card>

    <q-card v-else class="q-pa-lg">
      <q-card-section class="q-pa-none q-mb-md">
        <span class="text-h5">Relay</span>
      </q-card-section>
      <q-card-section class="q-pa-none q-col-gutter-md">
         
<q-input
  filled
  dense
  v-model.trim="publicRelay.npub"
  label="Npub"
  hint=" "
></q-input>
  
<q-input
  filled
  dense
  v-model.trim="publicRelay.sats"
  label="Sats"
  hint=" "
  type="number"
></q-input>
 
      </q-card-section>

      <q-card-section class="q-pa-none q-mt-md">
        <div class="row">
          <div class="col">
            <q-btn
              @click="submitRelay"
              unelevated
              color="primary"
              class="float-right"
            >
              <span>Submit</span>
            </q-btn>
          </div>
        </div>
      </q-card-section>
      <q-card-section></q-card-section>
    </q-card>
  </div>
  <div class="col-12 col-sm-6 col-md-5 col-lg-4 q-gutter-y-md">
    <q-card>
      <q-card-section>
        <h6 class="q-mb-sm q-mt-none">{{ public_page_name }}</h6>
        <p class="q-my-none">{{ public_page_description }}</p>
      </q-card-section>
    </q-card>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  window.app = Vue.createApp({
    el: '#vue',
    mixins: [windowMixin],
    data: function () {
      return {
        paymentRequest: '',
        paymentHash: '',
        invoicePaid: false,
        serverId: '{{ server_id }}',
        relayId: null,
        publicRelay: {}
      }
    },
    methods: {
      async submitRelay() {
        
        try {
          const {data} = await LNbits.api.request(
            'PUT',
            `/bitsatcredit/api/v1/relay/public/${this.serverId}`,
            null,
            this.publicRelay
          )
          this.relayId = data.relay_id
          this.paymentHash = data.payment_hash
          this.paymentRequest = data.payment_request

          this.waitForPayment(this.paymentHash)
          Quasar.Notify.create({
            type: 'positive',
            message: this.$t('Relay submitted')
          })
        } catch (error) {
          LNbits.utils.notifyApiError(error)
        }
      },
      async waitForPayment(paymentHash) {
        try {
          const url = new URL(window.location)
          url.protocol = url.protocol === 'https:' ? 'wss' : 'ws'
          url.pathname = `/api/v1/ws/${paymentHash}`
          const ws = new WebSocket(url)
          ws.addEventListener('message', async ({data}) => {
            const payment = JSON.parse(data)
            if (payment.pending === false) {
              this.invoicePaid = true
              Quasar.Notify.create({
                type: 'positive',
                message: 'Invoice Paid!'
              })
              ws.close()
            }
          })
        } catch (err) {
          console.warn(err)
          Quasar.Notify.create({
            type: 'negative',
            message: 'Error waiting for payment.'
          })
        }
      }
    },
    created: function () {
      // Will trigger payment reaction when payment received, sent from tasks.py
    }
  })
</script>
{% endblock %}