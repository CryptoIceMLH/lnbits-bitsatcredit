<!--/////////////////////////////////////////////////-->
<!--/////////// BitSatCredit Top-Up Page ////////////-->
<!--/////////////////////////////////////////////////-->

{% extends "public.html" %}
{% block page %}
<div class="row q-col-gutter-md justify-center">
  <div class="col-12 col-sm-8 col-md-6 col-lg-5">
    <!-- System Status Banner -->
    <q-banner
      v-if="systemStatus"
      :class="systemStatus.is_online ? 'bg-positive text-white' : 'bg-negative text-white'"
      class="q-mb-md"
    >
      <template v-slot:avatar>
        <q-icon :name="systemStatus.is_online ? 'wifi' : 'wifi_off'" color="white"></q-icon>
      </template>
      <strong>${ systemStatus.is_online ? 'ðŸŸ¢ SYSTEM ONLINE' : 'ðŸ”´ SYSTEM OFFLINE' }</strong>
      <div v-if="systemStatus.message" class="q-mt-xs text-caption">
        ${ systemStatus.message }
      </div>
    </q-banner>

    <!-- Success State - Payment Confirmed -->
    <q-card v-if="invoicePaid" class="q-pa-lg text-center">
      <q-card-section>
        <q-icon
          name="check_circle"
          color="positive"
          style="font-size: 5em"
        ></q-icon>
        <div class="text-h5 q-mt-md">Payment Received!</div>
        <div class="text-body1 q-mt-sm">
          Your account has been credited with <strong>${ topupAmount } sats</strong>
        </div>
        <div v-if="userBalance !== null" class="text-body2 q-mt-sm text-positive">
          <strong>New Balance: ${ userBalance } sats</strong>
        </div>
        <div class="text-caption q-mt-sm text-grey-7">
          Npub: ${ npub.substring(0, 20) }...
        </div>
      </q-card-section>
      <q-card-section>
        <q-btn
          unelevated
          color="primary"
          label="Top Up Again"
          @click="resetForm"
        ></q-btn>
      </q-card-section>
    </q-card>

    <!-- Payment Pending State - Show QR Code -->
    <q-card v-else-if="paymentRequest" class="q-pa-lg">
      <q-card-section>
        <div class="text-h5 text-center">Scan to Pay</div>
        <div class="text-body2 text-center text-grey-7 q-mt-xs">
          ${ topupAmount } sats
        </div>
      </q-card-section>

      <q-card-section class="q-pa-none q-mb-md flex flex-center">
        <lnbits-qrcode
          :href="'lightning:' + paymentRequest"
          :value="'lightning:' + paymentRequest"
        ></lnbits-qrcode>
      </q-card-section>

      <q-card-section>
        <q-input
          filled
          readonly
          dense
          v-model="paymentRequest"
          label="Lightning Invoice"
        >
          <template v-slot:append>
            <q-btn
              flat
              dense
              icon="content_copy"
              @click="copyToClipboard(paymentRequest)"
            >
              <q-tooltip>Copy Invoice</q-tooltip>
            </q-btn>
          </template>
        </q-input>
      </q-card-section>

      <q-card-section class="text-center">
        <q-spinner-dots color="primary" size="40px"></q-spinner-dots>
        <div class="text-caption q-mt-sm">Waiting for payment...</div>
      </q-card-section>
    </q-card>

    <!-- Initial Form State - Enter Details -->
    <q-card v-else class="q-pa-lg">
      <q-card-section>
        <div class="text-h5">Top Up Credits</div>
        <div class="text-body2 text-grey-7 q-mt-xs">
          Add Lightning credits to your BitSatRelay account
        </div>
      </q-card-section>

      <q-card-section class="q-gutter-md">
        <q-input
          filled
          dense
          v-model.trim="topupForm.npub"
          label="Your Nostr Public Key (npub)"
          hint="Enter your npub to top up your account"
          :rules="[
            val => !!val || 'Npub is required',
            val => val.startsWith('npub1') || 'Must start with npub1',
            val => val.length === 63 || 'Invalid npub length'
          ]"
        >
          <template v-slot:prepend>
            <q-icon name="person"></q-icon>
          </template>
        </q-input>

        <q-input
          filled
          dense
          v-model.number="topupForm.amount_sats"
          label="Amount (sats)"
          hint="Minimum 1 sat"
          type="number"
          :rules="[
            val => !!val || 'Amount is required',
            val => val >= 1 || 'Minimum 1 sat',
            val => val <= 100 || 'Maximum 100 sats'
          ]"
        >
          <template v-slot:prepend>
            <q-icon name="bolt"></q-icon>
          </template>
        </q-input>

        <!-- Quick Amount Buttons -->
        <div class="row q-gutter-sm justify-center">
          <q-btn
            outline
            color="primary"
            label="5"
            @click="topupForm.amount_sats = 5"
          ></q-btn>
          <q-btn
            outline
            color="primary"
            label="10"
            @click="topupForm.amount_sats = 10"
          ></q-btn>
          <q-btn
            outline
            color="primary"
            label="100"
            @click="topupForm.amount_sats = 100"
          ></q-btn>
        </div>
      </q-card-section>

      <q-card-section>
        <q-btn
          unelevated
          color="primary"
          class="full-width"
          label="Generate Invoice"
          @click="createTopUp"
          :disable="!isFormValid"
        ></q-btn>
      </q-card-section>

      <!-- Freedom Communications Banner -->
      <q-banner class="bg-primary text-white q-mt-md">
        <div class="text-center">
          <div class="text-subtitle1"><strong>âš¡ FREEDOM COMMUNICATIONS VIA BITCOIN âš¡</strong></div>
          <div class="text-caption q-mt-xs">
            BitSatRelay enables censorship-resistant satellite communications for Nostr messages powered by Bitcoin's Lightning Network. No governments, no gatekeepers - just pure peer-to-peer freedom of speech transmitted through space.
          </div>
        </div>
      </q-banner>

      <!-- Experimental Warning -->
      <q-banner class="bg-orange text-white q-mt-sm">
        <template v-slot:avatar>
          <q-icon name="warning" color="white"></q-icon>
        </template>
        <strong>EXPERIMENTAL PLATFORM:</strong> Maximum 100 sats per top-up. Credits may be lost at any time during testing. Use at your own risk.
      </q-banner>
    </q-card>
  </div>

  <!-- Info Sidebar -->
  <div class="col-12 col-sm-8 col-md-6 col-lg-4 q-gutter-y-md">
    <q-card>
      <q-card-section>
        <h6 class="q-mb-sm q-mt-none">BitSatCredit</h6>
        <p class="q-my-none">
          Top up your Lightning credits to send messages via BitSatRelay satellite network.
        </p>
      </q-card-section>
    </q-card>

    <q-card>
      <q-card-section>
        <div class="text-subtitle2 q-mb-sm">ðŸ“Š Network Stats</div>
        <div v-if="stats" class="q-gutter-y-sm">
          <div class="row items-center justify-between">
            <span class="text-caption text-grey-7">Total Users</span>
            <span class="text-body1"><strong>${ stats.total_users }</strong></span>
          </div>
          <q-separator></q-separator>
          <div class="row items-center justify-between">
            <span class="text-caption text-grey-7">Messages Sent</span>
            <span class="text-body1"><strong>${ stats.total_messages }</strong></span>
          </div>
        </div>
        <div v-else class="q-gutter-y-sm">
          <q-skeleton type="text" />
          <q-skeleton type="text" />
        </div>
      </q-card-section>
    </q-card>

    <q-card>
      <q-card-section>
        <div class="text-subtitle2 q-mb-sm">How it works</div>
        <ol class="q-pl-md q-my-none">
          <li>Enter your Nostr public key (npub)</li>
          <li>Choose the amount of sats to add</li>
          <li>Pay the Lightning invoice</li>
          <li>Credits are added instantly</li>
          <li>Use credits to send satellite messages</li>
        </ol>
      </q-card-section>
    </q-card>

    <q-card>
      <q-card-section>
        <div class="text-subtitle2 q-mb-sm">Pricing</div>
        <p class="q-my-none">
          <strong>1 sat per message</strong>
        </p>
        <p class="q-my-sm text-caption">
          Each satellite message costs 1 sat to send. Credits are deducted when your message is transmitted.
        </p>
      </q-card-section>
    </q-card>

    <q-card>
      <q-card-section>
        <div class="text-subtitle2 q-mb-sm">Satellite Nostr Relay</div>
        <p class="q-my-sm">
          Messages are transmitted via satellite using the BitSatRelay system.
        </p>

        <div class="q-mb-md">
          <div class="text-caption text-grey-7 q-mb-xs">Nostr Relay URL</div>
          <div class="row items-center q-gutter-sm bg-grey-2 q-pa-md rounded-borders">
            <div class="col text-body1 text-primary" style="font-family: monospace; word-break: break-all;">
              wss://bitsat.molonlabe.holdings
            </div>
            <q-btn
              flat
              dense
              round
              icon="content_copy"
              color="primary"
              @click="copyRelayUrl"
            >
              <q-tooltip>Copy Relay URL</q-tooltip>
            </q-btn>
          </div>
        </div>

        <p class="q-my-sm text-caption">
          Connect your Nostr client to this relay to send and receive satellite messages.
          Your npub is used to identify your account for credit deduction.
        </p>
        <p class="q-my-sm text-caption">
          <strong>How to send:</strong> Post a note from any Nostr client connected to the relay.
          The system will automatically deduct 1 sat from your balance and transmit your message via satellite.
        </p>
        <p class="q-my-sm text-caption">
          <strong>Relay Bot:</strong> Your relayed messages will be broadcasted from
          <a href="https://njump.me/npub14uee3fwxjwq7m25gsyqguv2t6v8ft69jax4lvs3skfpa8u7thdsqpu7gam" target="_blank" class="text-primary">
            npub14uee...7thdsqpu7gam
          </a>
        </p>

        <q-expansion-item
          label="How to Connect Your Nostr Client"
          icon="help_outline"
          class="q-mt-md"
        >
          <q-card>
            <q-card-section class="text-caption">
              <p class="q-my-sm"><strong>Desktop (Nostr clients like Amethyst, Damus, etc.):</strong></p>
              <ol class="q-pl-md q-my-sm">
                <li>Open your Nostr client settings</li>
                <li>Navigate to "Relays" or "Relay Settings"</li>
                <li>Click "Add Relay"</li>
                <li>Paste: <code>wss://bitsat.molonlabe.holdings</code></li>
                <li>Enable both read and write</li>
              </ol>
              <p class="q-my-sm"><strong>Web Clients:</strong></p>
              <p class="q-my-sm">Most web clients like Snort, Iris, and Coracle have a relay management page where you can add custom relays.</p>
            </q-card-section>
          </q-card>
        </q-expansion-item>
      </q-card-section>
    </q-card>

    <q-card>
      <q-card-section>
        <div class="text-subtitle2 q-mb-sm">Check Balance</div>
        <q-input
          filled
          dense
          v-model.trim="balanceCheckNpub"
          label="Enter your npub"
          hint="Check your current balance"
        >
          <template v-slot:append>
            <q-btn
              flat
              dense
              icon="search"
              @click="checkBalance"
              :loading="balanceLoading"
            >
              <q-tooltip>Check Balance</q-tooltip>
            </q-btn>
          </template>
        </q-input>

        <div v-if="balanceInfo" class="q-mt-md">
          <div class="q-pa-md bg-blue-1 rounded-borders text-blue-9">
            <div class="row items-center justify-between">
              <div class="text-subtitle2">Balance: <strong>${ balanceInfo.balance_sats } sats</strong></div>
              <q-btn
                flat
                dense
                round
                size="sm"
                icon="content_copy"
                color="blue-9"
                @click="copyToClipboard(balanceCheckNpub)"
              >
                <q-tooltip>Copy npub</q-tooltip>
              </q-btn>
            </div>
            <div class="text-caption q-mt-xs">Messages sent: ${ balanceInfo.message_count }</div>
            <div class="text-caption">Total spent: ${ balanceInfo.total_spent } sats</div>
            <div class="text-caption">Total deposited: ${ balanceInfo.total_deposited } sats</div>
          </div>

          <q-btn
            v-if="!showTransactions"
            flat
            dense
            label="View Transaction History"
            icon="history"
            color="primary"
            class="q-mt-sm"
            @click="loadTransactions"
            :loading="transactionsLoading"
          />

          <div v-if="showTransactions && transactions.length > 0" class="q-mt-md">
            <div class="text-caption text-grey-7 q-mb-xs">Recent Transactions</div>
            <q-list bordered separator class="rounded-borders">
              <q-item v-for="tx in transactions" :key="tx.id" dense>
                <q-item-section>
                  <q-item-label caption>${ tx.memo }</q-item-label>
                  <q-item-label caption>${ new Date(tx.created_at * 1000).toLocaleString() }</q-item-label>
                </q-item-section>
                <q-item-section side>
                  <q-badge :color="tx.type === 'deposit' ? 'positive' : 'negative'">
                    ${ tx.type === 'deposit' ? '+' : '-' }${ tx.amount_sats } sats
                  </q-badge>
                </q-item-section>
              </q-item>
            </q-list>
          </div>

          <div v-if="showTransactions && transactions.length === 0" class="q-mt-md text-caption text-grey-7">
            No transactions found
          </div>
        </div>

        <div v-if="balanceError" class="q-mt-md q-pa-md bg-red-1 rounded-borders text-red-8">
          ${ balanceError }
        </div>
      </q-card-section>
    </q-card>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.app = Vue.createApp({
    el: '#vue',
    mixins: [windowMixin],
    delimiters: ['${', '}'],
    data: function () {
      return {
        walletId: '{{ wallet_id }}',
        topupForm: {
          npub: '',
          amount_sats: null
        },
        paymentRequest: '',
        paymentHash: '',
        topupId: '',
        invoicePaid: false,
        npub: '',
        topupAmount: 0,
        balanceCheckNpub: '',
        balanceInfo: null,
        balanceError: '',
        balanceLoading: false,
        systemStatus: null,
        stats: null,
        userBalance: null,
        showTransactions: false,
        transactions: [],
        transactionsLoading: false
      }
    },
    computed: {
      isFormValid() {
        return (
          this.topupForm.npub &&
          this.topupForm.npub.startsWith('npub1') &&
          this.topupForm.npub.length === 63 &&
          this.topupForm.amount_sats >= 1
        )
      }
    },
    methods: {
      async getSystemStatus() {
        try {
          const {data} = await LNbits.api.request(
            'GET',
            '/bitsatcredit/api/v1/system/status',
            null
          )
          this.systemStatus = data
        } catch (error) {
          console.error('Error fetching system status:', error)
          // Default to online if can't fetch
          this.systemStatus = { status: 'online', is_online: true, message: '' }
        }
      },

      async getStats() {
        try {
          const {data} = await LNbits.api.request(
            'GET',
            '/bitsatcredit/api/v1/stats',
            null
          )
          this.stats = data
        } catch (error) {
          console.error('Error fetching stats:', error)
        }
      },

      async createTopUp() {
        try {
          // Call public endpoint with wallet_id query parameter (no auth required)
          const {data} = await LNbits.api.request(
            'POST',
            `/bitsatcredit/api/v1/topup?wallet_id=${this.walletId}`,
            null,  // No auth key needed for public endpoint
            this.topupForm
          )

          this.topupId = data.topup_id
          this.paymentHash = data.payment_hash
          this.paymentRequest = data.bolt11
          this.npub = this.topupForm.npub
          this.topupAmount = this.topupForm.amount_sats

          this.waitForPayment(this.paymentHash)

          Quasar.Notify.create({
            type: 'positive',
            message: 'Invoice generated! Please pay to add credits.'
          })
        } catch (error) {
          LNbits.utils.notifyApiError(error)
        }
      },

      async waitForPayment(paymentHash) {
        // Try WebSocket first, fall back to polling
        let wsConnected = false
        let pollInterval = null

        try {
          const url = new URL(window.location)
          url.protocol = url.protocol === 'https:' ? 'wss' : 'ws'
          url.pathname = `/api/v1/ws/${paymentHash}`

          const ws = new WebSocket(url)

          ws.addEventListener('open', () => {
            console.log('WebSocket connected')
            wsConnected = true
          })

          ws.addEventListener('message', async ({data}) => {
            const payment = JSON.parse(data)
            if (payment.pending === false) {
              await this.fetchUserBalance()
              this.invoicePaid = true
              this.balanceCheckNpub = this.npub

              Quasar.Notify.create({
                type: 'positive',
                message: 'Payment received! Credits added to your account.',
                timeout: 5000
              })

              ws.close()
              if (pollInterval) clearInterval(pollInterval)
            }
          })

          ws.addEventListener('error', (error) => {
            console.warn('WebSocket error, falling back to polling:', error)
            wsConnected = false
          })

          ws.addEventListener('close', () => {
            console.log('WebSocket closed')
          })

        } catch (err) {
          console.warn('WebSocket failed, using polling:', err)
        }

        // Fallback: Poll for payment status every 2 seconds
        pollInterval = setInterval(async () => {
          try {
            // Check if top-up has been paid by checking user balance
            const {data} = await LNbits.api.request(
              'GET',
              `/bitsatcredit/api/v1/user/${this.npub}/balance`,
              null
            )

            // If balance increased, payment was received
            if (data.balance_sats >= this.topupAmount) {
              await this.fetchUserBalance()
              this.invoicePaid = true
              this.balanceCheckNpub = this.npub

              Quasar.Notify.create({
                type: 'positive',
                message: 'Payment received! Credits added to your account.',
                timeout: 5000
              })

              clearInterval(pollInterval)
            }
          } catch (error) {
            console.warn('Polling error:', error)
          }
        }, 2000)
      },

      copyToClipboard(text) {
        navigator.clipboard.writeText(text)
        Quasar.Notify.create({
          type: 'positive',
          message: 'Invoice copied to clipboard',
          timeout: 1000
        })
      },

      copyRelayUrl() {
        navigator.clipboard.writeText('wss://bitsat.molonlabe.holdings')
        Quasar.Notify.create({
          type: 'positive',
          message: 'Relay URL copied to clipboard',
          timeout: 1000
        })
      },

      async fetchUserBalance() {
        try {
          const {data} = await LNbits.api.request(
            'GET',
            `/bitsatcredit/api/v1/user/${this.npub}/balance`,
            null
          )
          this.userBalance = data.balance_sats
        } catch (error) {
          console.error('Error fetching user balance:', error)
        }
      },

      async checkBalance() {
        if (!this.balanceCheckNpub || !this.balanceCheckNpub.startsWith('npub1') || this.balanceCheckNpub.length !== 63) {
          this.balanceError = 'Please enter a valid npub (must start with npub1 and be 63 characters)'
          this.balanceInfo = null
          this.showTransactions = false
          return
        }

        try {
          this.balanceLoading = true
          this.balanceError = ''
          this.balanceInfo = null
          this.showTransactions = false

          const {data} = await LNbits.api.request(
            'GET',
            `/bitsatcredit/api/v1/user/${this.balanceCheckNpub}/balance`,
            null
          )

          this.balanceInfo = data
        } catch (error) {
          this.balanceError = 'Unable to fetch balance. User may not exist yet.'
          this.balanceInfo = null
        } finally {
          this.balanceLoading = false
        }
      },

      async loadTransactions() {
        try {
          this.transactionsLoading = true
          const {data} = await LNbits.api.request(
            'GET',
            `/bitsatcredit/api/v1/user/${this.balanceCheckNpub}/transactions`,
            null
          )
          this.transactions = data
          this.showTransactions = true
        } catch (error) {
          console.error('Error loading transactions:', error)
          Quasar.Notify.create({
            type: 'negative',
            message: 'Failed to load transactions'
          })
        } finally {
          this.transactionsLoading = false
        }
      },

      resetForm() {
        this.topupForm = {
          npub: '',
          amount_sats: null
        }
        this.paymentRequest = ''
        this.paymentHash = ''
        this.topupId = ''
        this.invoicePaid = false
        this.npub = ''
        this.topupAmount = 0
        this.userBalance = null
        this.showTransactions = false
        this.transactions = []
      }
    },
    created: function () {
      // Initialize form and fetch system status and stats
      this.getSystemStatus()
      this.getStats()
    }
  })
</script>
{% endblock %}
