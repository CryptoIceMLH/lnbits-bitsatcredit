<!--/////////////////////////////////////////////////-->
<!--/////////// BitSatCredit Top-Up Page ////////////-->
<!--/////////////////////////////////////////////////-->

{% extends "public.html" %}

{% block title %}BitSat Relay - Freedom Communications{% endblock %}

{% block page %}
<div class="row q-col-gutter-md justify-center">
  <div class="col-12 col-sm-8 col-md-6 col-lg-5">
    <!-- System Status - Small Edge Indicator -->
    <div v-if="systemStatus" class="row q-mb-md">
      <div class="col-auto">
        <q-badge
          :color="systemStatus.is_online ? 'positive' : 'negative'"
          :label="systemStatus.is_online ? 'ONLINE' : 'OFFLINE'"
          class="q-px-md q-py-xs"
        >
          <q-icon :name="systemStatus.is_online ? 'wifi' : 'wifi_off'" left />
        </q-badge>
      </div>
      <div v-if="systemStatus.message" class="col q-pl-sm text-caption self-center">
        ${ systemStatus.message }
      </div>
    </div>

    <!-- Success State - Payment Confirmed -->
    <q-card v-if="invoicePaid" class="q-pa-md text-center">
      <q-card-section>
        <q-icon
          name="check_circle"
          color="positive"
          style="font-size: 4em"
        ></q-icon>
        <div class="text-h6 q-mt-sm">Payment Received!</div>
        <div class="text-body2 q-mt-xs">
          Credited with <strong>${ topupAmount } sats</strong>
        </div>
        <div v-if="userBalance !== null" class="text-body2 q-mt-xs text-positive">
          <strong>New Balance: ${ userBalance } sats</strong>
        </div>
        <div class="text-caption q-mt-xs text-grey-7">
          ${ npub.substring(0, 20) }...
        </div>
      </q-card-section>
      <q-card-section>
        <q-btn
          unelevated
          color="primary"
          label="Top Up Again"
          @click="resetForm"
        ></q-btn>
      </q-card-section>
    </q-card>

    <!-- Payment Pending State - Show QR Code -->
    <q-card v-else-if="paymentRequest" class="q-pa-md">
      <q-card-section>
        <div class="text-h6 text-center">Scan to Pay</div>
        <div class="text-body2 text-center text-grey-7 q-mt-xs">
          ${ topupAmount } sats
        </div>
      </q-card-section>

      <q-card-section class="q-pa-none q-mb-md flex flex-center">
        <lnbits-qrcode
          :href="'lightning:' + paymentRequest"
          :value="'lightning:' + paymentRequest"
        ></lnbits-qrcode>
      </q-card-section>

      <q-card-section>
        <q-input
          filled
          readonly
          dense
          v-model="paymentRequest"
          label="Lightning Invoice"
        >
          <template v-slot:append>
            <q-btn
              flat
              dense
              icon="content_copy"
              @click="copyToClipboard(paymentRequest)"
            >
              <q-tooltip>Copy Invoice</q-tooltip>
            </q-btn>
          </template>
        </q-input>
      </q-card-section>

      <q-card-section class="text-center">
        <q-spinner-dots color="primary" size="40px"></q-spinner-dots>
        <div class="text-caption q-mt-sm">Waiting for payment...</div>
      </q-card-section>
    </q-card>

    <!-- Initial Form State - Enter Details -->
    <q-card v-else class="q-pa-md">
      <q-card-section>
        <div class="text-body1 text-weight-bold">Add Lightning Credits to Your BitSatRelay Account</div>
        <div class="text-h6 q-mt-xs">Top Up Credits</div>
      </q-card-section>

      <q-card-section class="q-gutter-sm">
        <q-input
          filled
          dense
          v-model.trim="topupForm.npub"
          label="Your Nostr Public Key (npub)"
          hint="Enter your npub to top up"
          :rules="[
            val => !!val || 'Npub is required',
            val => val.startsWith('npub1') || 'Must start with npub1',
            val => val.length === 63 || 'Invalid npub length'
          ]"
        >
          <template v-slot:prepend>
            <q-icon name="person"></q-icon>
          </template>
        </q-input>

        <q-input
          filled
          dense
          v-model.number="topupForm.amount_sats"
          label="Amount (sats)"
          hint="Minimum 1 sat"
          type="number"
          :rules="[
            val => !!val || 'Amount is required',
            val => val >= 1 || 'Minimum 1 sat'
          ]"
        >
          <template v-slot:prepend>
            <q-icon name="bolt"></q-icon>
          </template>
        </q-input>

        <q-input
          filled
          dense
          v-model="topupForm.memo"
          label="Memo (optional)"
          hint="Note for this top-up"
        >
          <template v-slot:prepend>
            <q-icon name="notes"></q-icon>
          </template>
        </q-input>

        <!-- Quick Amount Buttons -->
        <div class="row q-gutter-xs justify-center">
          <q-btn
            outline
            dense
            color="primary"
            label="5k"
            @click="topupForm.amount_sats = 5000"
          ></q-btn>
          <q-btn
            outline
            dense
            color="primary"
            label="10k"
            @click="topupForm.amount_sats = 10000"
          ></q-btn>
          <q-btn
            outline
            dense
            color="primary"
            label="25k"
            @click="topupForm.amount_sats = 25000"
          ></q-btn>
          <q-btn
            outline
            dense
            color="primary"
            label="50k"
            @click="topupForm.amount_sats = 50000"
          ></q-btn>
          <q-btn
            outline
            dense
            color="primary"
            label="100k"
            @click="topupForm.amount_sats = 100000"
          ></q-btn>
        </div>
      </q-card-section>

      <q-card-section>
        <q-btn
          unelevated
          color="primary"
          class="full-width"
          label="Generate Invoice"
          @click="createTopUp"
          :disable="!isFormValid"
        ></q-btn>
      </q-card-section>

      <!-- Freedom Communications Banner -->
      <q-banner class="bg-primary text-white q-mt-sm">
        <div class="text-center">
          <div class="text-subtitle2"><strong>FREEDOM COMMUNICATIONS VIA BITCOIN</strong></div>
          <div class="text-caption q-mt-xs">
            BitSatRelay: Censorship-resistant satellite communications for Nostr. Messages transmitted through space via Bitcoin's Lightning Network - no governments, no gatekeepers, just pure peer-to-peer freedom of speech.
          </div>
        </div>
      </q-banner>
    </q-card>
  </div>

  <!-- Right Sidebar - Compact Info -->
  <div class="col-12 col-sm-8 col-md-6 col-lg-4 q-gutter-y-sm">
    <!-- Check Balance, Pricing, Stats Combined -->
    <q-card>
      <q-card-section class="q-pa-sm">
        <div class="text-subtitle2 q-mb-xs">Check Balance</div>
        <q-input
          filled
          dense
          v-model.trim="balanceCheckNpub"
          label="Enter your npub"
          hint="Check current balance"
        >
          <template v-slot:append>
            <q-btn
              flat
              dense
              icon="search"
              @click="checkBalance"
              :loading="balanceLoading"
            >
              <q-tooltip>Check Balance</q-tooltip>
            </q-btn>
          </template>
        </q-input>

        <div v-if="balanceInfo" class="q-mt-sm">
          <div class="q-pa-sm bg-blue-1 rounded-borders text-blue-9">
            <div class="row items-center justify-between">
              <div class="text-body2">Balance: <strong>${ balanceInfo.balance_sats } sats</strong></div>
              <q-btn
                flat
                dense
                round
                size="xs"
                icon="content_copy"
                color="blue-9"
                @click="copyToClipboard(balanceCheckNpub)"
              >
                <q-tooltip>Copy npub</q-tooltip>
              </q-btn>
            </div>
            <div class="text-caption q-mt-xs">Messages sent: ${ balanceInfo.message_count }</div>
            <div class="text-caption">Total spent: ${ balanceInfo.total_spent } sats</div>
          </div>

          <q-btn
            v-if="!showTransactions"
            flat
            dense
            label="View Transactions"
            icon="history"
            color="primary"
            class="q-mt-xs"
            size="sm"
            @click="loadTransactions"
            :loading="transactionsLoading"
          />

          <div v-if="showTransactions && transactions.length > 0" class="q-mt-xs">
            <div class="text-caption text-grey-7 q-mb-xs">Recent Transactions</div>
            <q-list bordered separator dense class="rounded-borders">
              <q-item v-for="tx in transactions" :key="tx.id" dense>
                <q-item-section>
                  <q-item-label caption>${ tx.memo }</q-item-label>
                  <q-item-label caption>${ new Date(tx.created_at * 1000).toLocaleString() }</q-item-label>
                </q-item-section>
                <q-item-section side>
                  <q-badge :color="tx.type === 'deposit' ? 'positive' : 'negative'" dense>
                    ${ tx.type === 'deposit' ? '+' : '-' }${ tx.amount_sats }
                  </q-badge>
                </q-item-section>
              </q-item>
            </q-list>
          </div>
        </div>

        <div v-if="balanceError" class="q-mt-sm q-pa-sm bg-red-1 rounded-borders text-red-8 text-caption">
          ${ balanceError }
        </div>
      </q-card-section>

      <q-separator></q-separator>

      <q-card-section class="q-pa-sm">
        <div class="text-subtitle2 q-mb-xs">Pricing</div>
        <p class="q-my-none text-body2">
          <strong>${ pricePerMessage } sat per message</strong>
        </p>
        <p class="q-my-xs text-caption">
          Each satellite message costs ${ pricePerMessage } sat. Credits are deducted when your message is transmitted.
        </p>
      </q-card-section>

      <q-separator></q-separator>

      <q-card-section class="q-pa-sm">
        <div class="text-subtitle2 q-mb-xs">Network Stats</div>
        <div v-if="stats" class="q-gutter-y-xs">
          <div class="row items-center justify-between">
            <span class="text-caption text-grey-7">Total Users</span>
            <span class="text-body2"><strong>${ stats.total_users }</strong></span>
          </div>
          <div class="row items-center justify-between">
            <span class="text-caption text-grey-7">Messages Sent</span>
            <span class="text-body2"><strong>${ stats.total_messages }</strong></span>
          </div>
        </div>
      </q-card-section>
    </q-card>

    <!-- What is BitSatRelay? -->
    <q-card>
      <q-card-section class="q-pa-sm">
        <div class="text-subtitle2 q-mb-xs">What is BitSatRelay?</div>
        <p class="q-my-xs text-body2">
          BitSatRelay enables uncensorable communications for everyone, everywhere. Whether you're living off-grid, facing emergencies, during natural disasters, or in areas with civil unrest - your freedom to communicate cannot be silenced.
        </p>
        <p class="q-my-xs text-body2">
          Using amateur radio satellite communications combined with Bitcoin's Lightning Network and Nostr protocol, messages are transmitted through space beyond the reach of any government or corporation.
        </p>
        <p class="q-my-xs text-caption text-weight-bold">
          True freedom of speech. Uncensorable. Unstoppable.
        </p>
      </q-card-section>
    </q-card>

    <!-- Open Source Repos -->
    <q-card>
      <q-card-section class="q-pa-sm">
        <div class="text-subtitle2 q-mb-xs">Open Source</div>
        <div class="q-gutter-y-sm">
          <div>
            <div class="text-caption text-grey-7 q-mb-xs">Software Repository</div>
            <a
              href="https://github.com/CryptoIceMLH/lnbits-bitsatcredit"
              target="_blank"
              class="text-primary text-body2"
              style="text-decoration: none; word-break: break-all; display: block;"
            >
              <q-icon name="code" size="sm" class="q-mr-xs" />
              <span style="vertical-align: middle;">github.com/CryptoIceMLH/lnbits-bitsatcredit</span>
            </a>
          </div>
          <div class="q-mt-sm">
            <div class="text-caption text-grey-7 q-mb-xs">Hardware Repository</div>
            <a
              href="https://github.com/CryptoIceMLH/BitSatRelay-Ground-Station"
              target="_blank"
              class="text-primary text-body2"
              style="text-decoration: none; word-break: break-all; display: block;"
            >
              <q-icon name="hardware" size="sm" class="q-mr-xs" />
              <span style="vertical-align: middle;">github.com/CryptoIceMLH/BitSatRelay-Ground-Station</span>
            </a>
          </div>
        </div>
      </q-card-section>
    </q-card>

    <!-- Satellite Relay Info -->
    <q-card>
      <q-card-section class="q-pa-sm">
        <div class="text-subtitle2 q-mb-xs">Nostr Relay</div>
        <p class="q-my-xs text-caption">
          Connect your Nostr client to receive satellite messages and send via satellite.
        </p>

        <div class="q-mb-sm">
          <div class="row items-center q-gutter-xs bg-grey-2 q-pa-xs rounded-borders">
            <div class="col text-caption text-primary" style="font-family: monospace; word-break: break-all;">
              wss://bitsat.molonlabe.holdings
            </div>
            <q-btn
              flat
              dense
              round
              size="xs"
              icon="content_copy"
              color="primary"
              @click="copyRelayUrl"
            >
              <q-tooltip>Copy Relay URL</q-tooltip>
            </q-btn>
          </div>
        </div>

        <p class="q-my-xs text-caption">
          <strong>Relay Bot:</strong>
          <a href="https://njump.me/npub14uee3fwxjwq7m25gsyqguv2t6v8ft69jax4lvs3skfpa8u7thdsqpu7gam" target="_blank" class="text-primary">
            npub14uee...pu7gam
          </a>
        </p>

        <q-expansion-item
          dense
          label="How to Connect"
          icon="help_outline"
          class="q-mt-xs"
        >
          <q-card>
            <q-card-section class="text-caption q-pa-xs">
              <p class="q-my-xs"><strong>Nostr Clients:</strong></p>
              <ol class="q-pl-md q-my-xs">
                <li>Open client settings</li>
                <li>Navigate to "Relays"</li>
                <li>Add: <code>wss://bitsat.molonlabe.holdings</code></li>
                <li>Enable read and write</li>
              </ol>
            </q-card-section>
          </q-card>
        </q-expansion-item>
      </q-card-section>
    </q-card>

    <!-- How It Works -->
    <q-card>
      <q-card-section class="q-pa-sm">
        <div class="text-subtitle2 q-mb-xs">How It Works</div>
        <ol class="q-pl-md q-my-none text-caption">
          <li>Enter your Nostr npub</li>
          <li>Choose amount of sats</li>
          <li>Pay Lightning invoice</li>
          <li>Credits added instantly</li>
          <li>Send messages via satellite</li>
        </ol>
      </q-card-section>
    </q-card>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.app = Vue.createApp({
    el: '#vue',
    mixins: [windowMixin],
    delimiters: ['${', '}'],
    data: function () {
      return {
        walletId: '{{ wallet_id }}',
        topupForm: {
          npub: '',
          amount_sats: null,
          memo: ''
        },
        paymentRequest: '',
        paymentHash: '',
        topupId: '',
        invoicePaid: false,
        npub: '',
        topupAmount: 0,
        balanceCheckNpub: '',
        balanceInfo: null,
        balanceError: '',
        balanceLoading: false,
        systemStatus: null,
        stats: null,
        userBalance: null,
        showTransactions: false,
        transactions: [],
        transactionsLoading: false,
        pricePerMessage: 1
      }
    },
    computed: {
      isFormValid() {
        return (
          this.topupForm.npub &&
          this.topupForm.npub.startsWith('npub1') &&
          this.topupForm.npub.length === 63 &&
          this.topupForm.amount_sats >= 1
        )
      }
    },
    methods: {
      async getSystemStatus() {
        try {
          const {data} = await LNbits.api.request(
            'GET',
            '/bitsatcredit/api/v1/system/status',
            null
          )
          this.systemStatus = data
        } catch (error) {
          console.error('Error fetching system status:', error)
          this.systemStatus = { status: 'online', is_online: true, message: '' }
        }
      },

      async getStats() {
        try {
          const {data} = await LNbits.api.request(
            'GET',
            '/bitsatcredit/api/v1/stats',
            null
          )
          this.stats = data
        } catch (error) {
          console.error('Error fetching stats:', error)
        }
      },

      async getPricePerMessage() {
        try {
          const {data} = await LNbits.api.request(
            'GET',
            '/bitsatcredit/api/v1/settings/price',
            null
          )
          this.pricePerMessage = data.price_per_message_sats
        } catch (error) {
          console.error('Error fetching price:', error)
          this.pricePerMessage = 1
        }
      },

      async createTopUp() {
        try {
          const {data} = await LNbits.api.request(
            'POST',
            `/bitsatcredit/api/v1/topup?wallet_id=${this.walletId}`,
            null,
            this.topupForm
          )

          this.topupId = data.topup_id
          this.paymentHash = data.payment_hash
          this.paymentRequest = data.bolt11
          this.npub = this.topupForm.npub
          this.topupAmount = this.topupForm.amount_sats

          this.waitForPayment(this.paymentHash)

          Quasar.Notify.create({
            type: 'positive',
            message: 'Invoice generated! Please pay to add credits.'
          })
        } catch (error) {
          LNbits.utils.notifyApiError(error)
        }
      },

      async waitForPayment(paymentHash) {
        let wsConnected = false
        let pollInterval = null

        try {
          const url = new URL(window.location)
          url.protocol = url.protocol === 'https:' ? 'wss' : 'ws'
          url.pathname = `/api/v1/ws/${paymentHash}`

          const ws = new WebSocket(url)

          ws.addEventListener('open', () => {
            console.log('WebSocket connected')
            wsConnected = true
          })

          ws.addEventListener('message', async ({data}) => {
            const payment = JSON.parse(data)
            if (payment.pending === false) {
              await this.fetchUserBalance()
              this.invoicePaid = true
              this.balanceCheckNpub = this.npub

              Quasar.Notify.create({
                type: 'positive',
                message: 'Payment received! Credits added to your account.',
                timeout: 5000
              })

              ws.close()
              if (pollInterval) clearInterval(pollInterval)
            }
          })

          ws.addEventListener('error', (error) => {
            console.warn('WebSocket error, falling back to polling:', error)
            wsConnected = false
          })

          ws.addEventListener('close', () => {
            console.log('WebSocket closed')
          })

        } catch (err) {
          console.warn('WebSocket failed, using polling:', err)
        }

        pollInterval = setInterval(async () => {
          try {
            const {data} = await LNbits.api.request(
              'GET',
              `/bitsatcredit/api/v1/user/${this.npub}/balance`,
              null
            )

            if (data.balance_sats >= this.topupAmount) {
              await this.fetchUserBalance()
              this.invoicePaid = true
              this.balanceCheckNpub = this.npub

              Quasar.Notify.create({
                type: 'positive',
                message: 'Payment received! Credits added to your account.',
                timeout: 5000
              })

              clearInterval(pollInterval)
            }
          } catch (error) {
            console.warn('Polling error:', error)
          }
        }, 2000)
      },

      copyToClipboard(text) {
        navigator.clipboard.writeText(text)
        Quasar.Notify.create({
          type: 'positive',
          message: 'Copied to clipboard',
          timeout: 1000
        })
      },

      copyRelayUrl() {
        navigator.clipboard.writeText('wss://bitsat.molonlabe.holdings')
        Quasar.Notify.create({
          type: 'positive',
          message: 'Relay URL copied to clipboard',
          timeout: 1000
        })
      },

      async fetchUserBalance() {
        try {
          const {data} = await LNbits.api.request(
            'GET',
            `/bitsatcredit/api/v1/user/${this.npub}/balance`,
            null
          )
          this.userBalance = data.balance_sats
        } catch (error) {
          console.error('Error fetching user balance:', error)
        }
      },

      async checkBalance() {
        if (!this.balanceCheckNpub || !this.balanceCheckNpub.startsWith('npub1') || this.balanceCheckNpub.length !== 63) {
          this.balanceError = 'Please enter a valid npub (must start with npub1 and be 63 characters)'
          this.balanceInfo = null
          this.showTransactions = false
          return
        }

        try {
          this.balanceLoading = true
          this.balanceError = ''
          this.balanceInfo = null
          this.showTransactions = false

          const {data} = await LNbits.api.request(
            'GET',
            `/bitsatcredit/api/v1/user/${this.balanceCheckNpub}/balance`,
            null
          )

          this.balanceInfo = data
        } catch (error) {
          this.balanceError = 'Unable to fetch balance. User may not exist yet.'
          this.balanceInfo = null
        } finally {
          this.balanceLoading = false
        }
      },

      async loadTransactions() {
        try {
          this.transactionsLoading = true
          const {data} = await LNbits.api.request(
            'GET',
            `/bitsatcredit/api/v1/user/${this.balanceCheckNpub}/transactions`,
            null
          )
          this.transactions = data
          this.showTransactions = true
        } catch (error) {
          console.error('Error loading transactions:', error)
          Quasar.Notify.create({
            type: 'negative',
            message: 'Failed to load transactions'
          })
        } finally {
          this.transactionsLoading = false
        }
      },

      resetForm() {
        this.topupForm = {
          npub: '',
          amount_sats: null,
          memo: ''
        }
        this.paymentRequest = ''
        this.paymentHash = ''
        this.topupId = ''
        this.invoicePaid = false
        this.npub = ''
        this.topupAmount = 0
        this.userBalance = null
        this.showTransactions = false
        this.transactions = []
      }
    },
    created: function () {
      this.getSystemStatus()
      this.getStats()
      this.getPricePerMessage()
    }
  })
</script>
{% endblock %}
