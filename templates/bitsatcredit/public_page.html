<!--/////////////////////////////////////////////////-->
<!--/////////// BitSatCredit Top-Up Page ////////////-->
<!--/////////////////////////////////////////////////-->

{% extends "public.html" %}

{% block title %}BitSat Relay - Freedom Communications{% endblock %}

{% block page %}
<div class="row q-col-gutter-md justify-center">
  <div class="col-12 col-sm-8 col-md-6 col-lg-5">
    <!-- System Status and Nostr Relay - Top Info Bar -->
    <div class="row q-mb-md items-center">
      <div v-if="systemStatus" class="col-auto">
        <q-badge
          :color="systemStatus.is_online ? 'positive' : 'negative'"
          :label="systemStatus.is_online ? 'ONLINE' : 'OFFLINE'"
          class="q-px-md q-py-xs"
        >
          <q-icon :name="systemStatus.is_online ? 'wifi' : 'wifi_off'" left />
        </q-badge>
      </div>
      <div class="col q-pl-md">
        <div class="row items-center q-gutter-xs">
          <span class="text-caption text-grey-7">Nostr Relay:</span>
          <span class="text-caption text-primary" style="font-family: monospace;">wss://bitsat.molonlabe.holdings</span>
          <q-btn
            flat
            dense
            round
            size="xs"
            icon="content_copy"
            color="primary"
            @click="copyRelayUrl"
          >
            <q-tooltip>Copy Relay URL</q-tooltip>
          </q-btn>
        </div>
      </div>
    </div>

    <!-- Success State - Payment Confirmed -->
    <q-card v-if="invoicePaid" class="q-pa-md text-center">
      <q-card-section>
        <q-icon
          name="check_circle"
          color="positive"
          style="font-size: 5em"
        ></q-icon>
        <div class="text-h5 q-mt-md">Payment Received!</div>
        <div class="text-body1 q-mt-sm">
          Your account has been credited with <strong>${ topupAmount } sats</strong>
        </div>
        <div v-if="userBalance !== null" class="text-body2 q-mt-sm text-positive">
          <strong>New Balance: ${ userBalance } sats</strong>
        </div>
        <div class="text-caption q-mt-sm text-grey-7">
          Npub: ${ npub.substring(0, 20) }...
        </div>
      </q-card-section>
      <q-card-section>
        <q-btn
          unelevated
          color="primary"
          label="Top Up Again"
          @click="resetForm"
        ></q-btn>
      </q-card-section>
    </q-card>

    <!-- Payment Pending State - Show QR Code -->
    <q-card v-else-if="paymentRequest" class="q-pa-md">
      <q-card-section>
        <div class="text-h5 text-center">Scan to Pay</div>
        <div class="text-body2 text-center text-grey-7 q-mt-xs">
          ${ topupAmount } sats
        </div>
      </q-card-section>

      <q-card-section class="q-pa-none q-mb-md flex flex-center">
        <lnbits-qrcode
          :href="'lightning:' + paymentRequest"
          :value="paymentRequest"
        ></lnbits-qrcode>
      </q-card-section>

      <q-card-section class="q-pa-sm">
        <q-input
          filled
          dense
          readonly
          :value="paymentRequest"
          label="Lightning Invoice"
        >
          <template v-slot:append>
            <q-btn
              flat
              dense
              icon="content_copy"
              @click="copyToClipboard(paymentRequest)"
            >
              <q-tooltip>Copy Invoice</q-tooltip>
            </q-btn>
          </template>
        </q-input>
      </q-card-section>

      <q-card-section class="text-center">
        <q-spinner-dots color="primary" size="40px"></q-spinner-dots>
        <div class="text-caption q-mt-sm">Waiting for payment...</div>
      </q-card-section>
    </q-card>

    <!-- Initial Form State - Enter Details -->
    <q-card v-else class="q-pa-sm">
      <q-card-section>
        <div class="text-h5 text-weight-bold">Add Lightning Credits to Your BitSatRelay Account</div>
        <div class="text-subtitle2 q-mt-xs">Top Up Credits</div>
      </q-card-section>

      <q-card-section class="q-gutter-sm">
        <q-input
          filled
          dense
          v-model.trim="topupForm.npub"
          label="Your Nostr Public Key (npub)"
          hint="Enter your npub to top up"
          :rules="[
            val => !!val || 'Npub is required',
            val => val.startsWith('npub1') || 'Must start with npub1',
            val => val.length === 63 || 'Invalid npub length'
          ]"
        >
          <template v-slot:prepend>
            <q-icon name="person"></q-icon>
          </template>
        </q-input>

        <q-input
          filled
          dense
          v-model.number="topupForm.amount_sats"
          label="Amount (sats)"
          hint="Minimum 1 sat"
          type="number"
          :rules="[
            val => !!val || 'Amount is required',
            val => val >= 1 || 'Minimum 1 sat'
          ]"
        >
          <template v-slot:prepend>
            <q-icon name="bolt"></q-icon>
          </template>
        </q-input>

        <q-input
          filled
          dense
          v-model="topupForm.memo"
          label="Memo (optional)"
          hint="Note for this top-up"
        >
          <template v-slot:prepend>
            <q-icon name="notes"></q-icon>
          </template>
        </q-input>

        <!-- Quick Amount Buttons -->
        <div class="row q-gutter-xs justify-center">
          <q-btn outline dense color="primary" label="5k" @click="topupForm.amount_sats = 5000"></q-btn>
          <q-btn outline dense color="primary" label="10k" @click="topupForm.amount_sats = 10000"></q-btn>
          <q-btn outline dense color="primary" label="25k" @click="topupForm.amount_sats = 25000"></q-btn>
          <q-btn outline dense color="primary" label="50k" @click="topupForm.amount_sats = 50000"></q-btn>
          <q-btn outline dense color="primary" label="100k" @click="topupForm.amount_sats = 100000"></q-btn>
        </div>
      </q-card-section>

      <q-card-section class="q-pt-none">
        <q-btn
          unelevated
          color="primary"
          class="full-width"
          label="Generate Invoice"
          @click="createTopUp"
          :disable="!isFormValid"
        ></q-btn>
      </q-card-section>
    </q-card>

    <!-- Combined Info Card -->
    <q-card class="q-mt-md">
      <q-card-section class="q-pa-sm">
        <!-- Check Balance -->
        <div class="text-subtitle2 q-mb-xs">Check Balance</div>
        <q-input
          filled
          dense
          v-model.trim="balanceCheckNpub"
          label="Enter your npub"
          hint="Check current balance"
        >
          <template v-slot:append>
            <q-btn
              flat
              dense
              icon="search"
              @click="checkBalance"
              :loading="balanceLoading"
            >
              <q-tooltip>Check Balance</q-tooltip>
            </q-btn>
          </template>
        </q-input>

        <div v-if="balanceInfo" class="q-mt-sm">
          <div class="q-pa-sm bg-blue-1 rounded-borders">
            <div class="text-subtitle2">Balance: <strong>${ balanceInfo.balance_sats } sats</strong></div>
            <div class="text-caption">Messages: ${ balanceInfo.message_count }</div>
          </div>
        </div>

        <q-separator class="q-my-sm"></q-separator>

        <!-- Pricing -->
        <div class="text-subtitle2 q-mb-xs">Pricing</div>
        <p class="q-my-none text-body2">
          <strong>${ pricePerMessage } sat per message</strong>
        </p>
        <p class="q-my-xs text-caption text-grey-7">
          Each satellite message costs ${ pricePerMessage } sat. Credits are deducted when transmitted.
        </p>

        <q-separator class="q-my-sm"></q-separator>

        <!-- Stats -->
        <div class="text-subtitle2 q-mb-xs">Network Stats</div>
        <div v-if="stats" class="q-gutter-y-xs">
          <div class="row items-center justify-between">
            <span class="text-caption text-grey-7">Total Users</span>
            <span class="text-body2"><strong>${ stats.total_users }</strong></span>
          </div>
          <div class="row items-center justify-between">
            <span class="text-caption text-grey-7">Messages Sent</span>
            <span class="text-body2"><strong>${ stats.total_messages }</strong></span>
          </div>
        </div>
      </q-card-section>
    </q-card>

    <!-- What is BitSatRelay? -->
    <q-card class="q-mt-md">
      <q-card-section class="q-pa-sm">
        <div class="text-subtitle2 q-mb-xs">What is BitSatRelay?</div>
        <p class="q-my-xs text-caption">
          BitSatRelay enables <strong>uncensorable communications</strong> for everyone, everywhere. Whether you're living off-grid, facing emergencies, during natural disasters, or in areas with civil unrest - your freedom to communicate cannot be silenced.
        </p>
        <p class="q-my-xs text-caption">
          Using amateur radio satellite communications combined with Bitcoin's Lightning Network and Nostr protocol, messages are transmitted through space beyond the reach of any government or corporation. True freedom of speech. Uncensorable. Unstoppable.
        </p>
      </q-card-section>
    </q-card>

    <!-- Open Source Repos -->
    <q-card class="q-mt-md">
      <q-card-section class="q-pa-sm">
        <div class="text-subtitle2 q-mb-sm">Open Source</div>

        <div class="q-mb-sm">
          <div class="text-caption text-grey-7 q-mb-xs">Software Repository</div>
          <a
            href="https://github.com/CryptoIceMLH/lnbits-bitsatcredit"
            target="_blank"
            class="text-primary"
            style="text-decoration: underline; font-size: 14px; display: inline-block;"
          >ðŸ”— View on GitHub</a>
        </div>

        <div>
          <div class="text-caption text-grey-7 q-mb-xs">Hardware Repository</div>
          <a
            href="https://github.com/CryptoIceMLH/BitSatRelay-Ground-Station"
            target="_blank"
            class="text-primary"
            style="text-decoration: underline; font-size: 14px; display: inline-block;"
          >ðŸ”— View on GitHub</a>
        </div>
      </q-card-section>
    </q-card>

    <!-- How It Works -->
    <q-card class="q-mt-md">
      <q-card-section class="q-pa-sm">
        <div class="text-subtitle2 q-mb-xs">How It Works</div>
        <ol class="q-pl-md q-my-none text-caption">
          <li>Enter your Nostr public key (npub)</li>
          <li>Choose amount of sats to add</li>
          <li>Pay Lightning invoice</li>
          <li>Credits added instantly</li>
          <li>Send satellite messages via Nostr relay</li>
        </ol>
      </q-card-section>
    </q-card>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.app = Vue.createApp({
    el: '#vue',
    mixins: [windowMixin],
    delimiters: ['${', '}'],
    data: function () {
      return {
        walletId: '{{ wallet_id }}',
        topupForm: {
          npub: '',
          amount_sats: null,
          memo: ''
        },
        paymentRequest: '',
        paymentHash: '',
        topupId: '',
        invoicePaid: false,
        npub: '',
        topupAmount: 0,
        balanceCheckNpub: '',
        balanceInfo: null,
        balanceError: '',
        balanceLoading: false,
        systemStatus: null,
        stats: null,
        userBalance: null,
        pricePerMessage: 1
      }
    },
    computed: {
      isFormValid() {
        return (
          this.topupForm.npub &&
          this.topupForm.npub.startsWith('npub1') &&
          this.topupForm.npub.length === 63 &&
          this.topupForm.amount_sats &&
          this.topupForm.amount_sats >= 1
        )
      }
    },
    methods: {
      async checkBalance() {
        if (!this.balanceCheckNpub || !this.balanceCheckNpub.startsWith('npub1')) {
          this.balanceError = 'Please enter a valid npub'
          return
        }

        this.balanceLoading = true
        this.balanceError = ''
        this.balanceInfo = null

        try {
          const {data} = await LNbits.api.request(
            'GET',
            `/bitsatcredit/api/v1/user/${this.balanceCheckNpub}/balance`,
            null
          )
          this.balanceInfo = data
        } catch (error) {
          this.balanceError = 'User not found or error fetching balance'
        } finally {
          this.balanceLoading = false
        }
      },

      async getSystemStatus() {
        try {
          const {data} = await LNbits.api.request(
            'GET',
            '/bitsatcredit/api/v1/system/status',
            null
          )
          this.systemStatus = data
        } catch (error) {
          this.systemStatus = { status: 'online', is_online: true, message: '' }
        }
      },

      async getStats() {
        try {
          const {data} = await LNbits.api.request(
            'GET',
            '/bitsatcredit/api/v1/stats',
            null
          )
          this.stats = data
        } catch (error) {
          console.error('Error fetching stats:', error)
        }
      },

      async getPricePerMessage() {
        try {
          const {data} = await LNbits.api.request(
            'GET',
            '/bitsatcredit/api/v1/settings/price',
            null
          )
          this.pricePerMessage = data.price_per_message_sats
        } catch (error) {
          console.error('Error fetching price:', error)
        }
      },

      async createTopUp() {
        try {
          const {data} = await LNbits.api.request(
            'POST',
            `/bitsatcredit/api/v1/topup?wallet_id=${this.walletId}`,
            null,
            this.topupForm
          )

          this.topupId = data.topup_id
          this.paymentHash = data.payment_hash
          this.paymentRequest = data.bolt11
          this.npub = this.topupForm.npub
          this.topupAmount = this.topupForm.amount_sats

          await this.waitForPayment(data.payment_hash)

          Quasar.Notify.create({
            type: 'positive',
            message: 'Invoice generated! Please pay to add credits.'
          })
        } catch (error) {
          LNbits.utils.notifyApiError(error)
        }
      },

      async waitForPayment(paymentHash) {
        const pollInterval = setInterval(async () => {
          try {
            const {data} = await LNbits.api.request(
              'GET',
              `/bitsatcredit/api/v1/user/${this.npub}/balance`,
              null
            )

            if (data.balance_sats >= this.topupAmount) {
              this.userBalance = data.balance_sats
              this.invoicePaid = true
              this.balanceCheckNpub = this.npub

              Quasar.Notify.create({
                type: 'positive',
                message: 'Payment received! Credits added.'
              })
              clearInterval(pollInterval)
            }
          } catch (error) {
            console.error('Polling error:', error)
          }
        }, 2000)
      },

      copyToClipboard(text) {
        navigator.clipboard.writeText(text)
        Quasar.Notify.create({
          type: 'positive',
          message: 'Copied to clipboard',
          timeout: 1000
        })
      },

      copyRelayUrl() {
        navigator.clipboard.writeText('wss://bitsat.molonlabe.holdings')
        Quasar.Notify.create({
          type: 'positive',
          message: 'Relay URL copied',
          timeout: 1000
        })
      },

      resetForm() {
        this.topupForm = {
          npub: '',
          amount_sats: null,
          memo: ''
        }
        this.paymentRequest = ''
        this.paymentHash = ''
        this.topupId = ''
        this.invoicePaid = false
        this.npub = ''
        this.topupAmount = 0
        this.userBalance = null
      }
    },
    created: function () {
      this.getSystemStatus()
      this.getStats()
      this.getPricePerMessage()
    }
  })
</script>
{% endblock %}
